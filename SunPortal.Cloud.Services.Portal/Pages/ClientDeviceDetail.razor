@attribute [Authorize]
@page "/client/device/detail/{deviceId}"
@using SunPortal.Cloud.Lib.App
@using SunPortal.Cloud.Lib.Interfaces
@using SunPortal.Cloud.Lib.Parameters
@using SunPortal.Cloud.Lib.UI

@inject IDevicesService DevicesService

@if (_device != null)
{
    <h3>@_device.DeviceType.Name (@_device.Address)</h3>
    <p>@_device.DeviceType.Description</p>
}
else
{
    <h3>@DeviceId</h3>
}



@if (_parameters != null)
{
    <div class="row">
        <LiveMainParametersComponent Device="_device"
                                Parameter="_parameters.Where(x => x.Priority == ParameterPriority.High)">

        </LiveMainParametersComponent>
    </div>

    <div class="row">
        @if (_charts != null)
        {
            foreach (Chart chart in _charts)
            {
                <div class="col-6">
                    @switch (chart.ChartType)
                    {
                        case ChartType.Line:
                            <ChartAreaComponent Chart="chart" DeviceId="Guid.Parse(DeviceId)"></ChartAreaComponent>
                            break;
                        case ChartType.Percentage:
                            break;
                        default:
                            throw new ArgumentOutOfRangeException();
                    }
                </div>
            }
        }

    </div>
    <MatDivider Inset="true"></MatDivider>
    <h4>Actions</h4>
    <div class="row actions">
        @foreach (var parameter in _parameters.Where(x => x.Priority == ParameterPriority.Special && x.Mode == ParameterMode.Write))
        {
            <div class="col-2">
                <ActionComponent Device="_device" Parameter="parameter"></ActionComponent>
            </div>
        }
    </div>
    <MatDivider Inset="true"></MatDivider>
    <h4>Parameters</h4>
    <MatAccordion>
        <MatExpansionPanel>
            <MatExpansionPanelSummary>
                <MatExpansionPanelHeader>Advance parameters</MatExpansionPanelHeader>
            </MatExpansionPanelSummary>
            <MatExpansionPanelDetails Style="padding: 3px !important;">
                <MatTable Items="@_parameters.Where(x => x.Priority == ParameterPriority.Medium || x.Priority == ParameterPriority.Special)" ShowPaging="true" UseSortHeaderRow="true" AllowSelection="true">
                    <MatTableHeader>
                        <MatSortHeaderRow>
                            <MatSortHeader SortId="name">
                                <span style="width:100px">Name</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="unit">
                                <span style="width:100px">Unit</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="mode">
                                <span style="width:100px">Mode</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="description">
                                <span style="width:200px">Description</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="value">
                                <span>Current value</span>
                            </MatSortHeader>
                        </MatSortHeaderRow>
                    </MatTableHeader>
                    <MatTableRow>
                        <td>
                            @context.ParameterId
                        </td>
                        <td>
                            @context.Unit
                        </td>
                        <td>
                            @context.Mode
                        </td>
                        <td>
                            @context.Description
                        </td>
                        <td>
                            <LiveValueComponent Device="_device" Parameter="context"></LiveValueComponent>
                        </td>
                    </MatTableRow>
                </MatTable>
            </MatExpansionPanelDetails>
        </MatExpansionPanel>

        <MatExpansionPanel>
            <MatExpansionPanelSummary>
                <MatExpansionPanelHeader>Other parameters</MatExpansionPanelHeader>
            </MatExpansionPanelSummary>
            <MatExpansionPanelDetails Style="padding: 3px !important;">
                <MatTable Items="@_parameters.Where(x => x.Priority == ParameterPriority.Low)" ShowPaging="true" UseSortHeaderRow="true" AllowSelection="true">
                    <MatTableHeader>
                        <MatSortHeaderRow>
                            <MatSortHeader SortId="name">
                                <span style="width:100px">Name</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="unit">
                                <span style="width:100px">Unit</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="mode">
                                <span style="width:100px">Mode</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="description">
                                <span style="width:200px">Description</span>
                            </MatSortHeader>
                            <MatSortHeader SortId="value">
                                <span>Current value</span>
                            </MatSortHeader>
                        </MatSortHeaderRow>
                    </MatTableHeader>
                    <MatTableRow>
                        <td>
                            @context.ParameterId
                        </td>
                        <td>
                            @context.Unit
                        </td>
                        <td>
                            @context.Mode
                        </td>
                        <td>
                            @context.Description
                        </td>
                        <td>
                            <LiveValueComponent Device="_device" Parameter="context"></LiveValueComponent>
                        </td>
                    </MatTableRow>
                </MatTable>
            </MatExpansionPanelDetails>
        </MatExpansionPanel>
    </MatAccordion>
}


@code {

    [Parameter]
    public string? DeviceId { get; set; }

    private IEnumerable<DeviceParameter>? _parameters;
    private IEnumerable<Chart>? _charts;
    private Device? _device;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var id = Guid.Parse(DeviceId);

            _charts = await DevicesService.DeviceCharts(id);
            _parameters = await DevicesService.ParametersByDevice(id);
            _device = await DevicesService.Device(id);

            StateHasChanged();
        }
    }


}