@using SunPortal.Cloud.Lib.Parameters
@using SunPortal.Cloud.Lib.App
@using System.Timers
@using SunPortal.Cloud.Services.Portal.Services
@using System.Reflection.Metadata

@implements IDisposable
@inject LiveValuesService Service

@if (Parameters != null)
{
    <div class="row">
        @foreach (var parameter in Parameters)
        {
            <div class="col-3">
                <LiveValueMainComponent Device="Device" Parameter="parameter"></LiveValueMainComponent>
            </div>
        }
        <div class="col-1">
            <section>
                <MatIcon Icon="refresh" @onclick="Request"></MatIcon>
            </section>
        </div>
        <div class="col-11">
            <section>
                Last update: @DateTime.Now.ToString("HH:mm:ss")
            </section>
        </div>
    </div>
}



@code {

    [Parameter]
    public IEnumerable<DeviceParameter>? Parameters { get; set; }

    [Parameter]
    public Device Device { get; set; }

    private Timer? _timer;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _timer = new();
            _timer.Interval = 60000; //TODO: const

            _timer.Elapsed += Update;


            _timer.Start();
        }
    }

    private void Update(object? sender, ElapsedEventArgs e)
    {
        Request();
    }

    private async void Request()
    {
        foreach (var parameter in Parameters)
        {
            Service.SendRequest(new()
            {
                Address = Device.Address,
                ClientId = Device.ClientId,
                Parameter = parameter.ParameterId
            },
                new()
                {
                    DeviceId = Device.ClientDeviceId,
                    Parameter = parameter.ParameterId
                });
        }
        await InvokeAsync(StateHasChanged);
    }


    public void Dispose()
    {
        if (_timer != null)
            _timer.Dispose();
    }

}